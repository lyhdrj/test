<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap namespace="RoleManage">

    <typeAlias alias="roleVO" type="com.nasoft.sysmanage.model.RoleBean"/>
    <typeAlias alias="MenuVO" type="com.nasoft.sysmanage.model.MenuBean"/>
    <typeAlias alias="RoleMenuVO" type="com.nasoft.sysmanage.model.RoleMenuBean"/>
    <typeAlias alias="PositionVO" type="com.nasoft.sysmanage.model.PositionBean"/>
    
    <resultMap id="roleResult" class="roleVO">
        <result property="roleID" column="role_id"/>
        <result property="companyCode" column="company_code"/>
        <result property="roleType" column="role_type"/>
        <result property="roleCode" column="role_code"/>
        <result property="roleName" column="role_name"/>
        <result property="roleStatus" column="role_status"/>
    </resultMap>
    
    <resultMap id="rolePrivileResult" class="MenuVO">
        <result property="menuID" column="menu_id"/>
        <result property="menuName" column="menu_name"/>
        <result property="parentMenuID" column="parent_menu_id"/>
        <result property="menuLevel" column="level"/>
    </resultMap>

   <select id="getRoleInfo" parameterClass="java.lang.String" resultMap="roleResult">
	select role_id, company_code, role_type, role_code, role_name, role_status 
	from tm_role where company_code=#companyCode# 
   </select>
   <select id="getUpdateRoleCount" parameterClass="roleVO" resultClass="java.lang.Integer">
   	select count(*) from tm_role where role_name=#roleName# and role_id !=#roleID# and company_code=#companyCode#
   </select>
   
   <select id="getInsertRoleCount" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
   	select count(*) from tm_role where role_name=#roleName# and company_code=#companyCode#
   </select>
   
   <insert id="insertRoleInfo" parameterClass="roleVO">
   	insert into tm_role(role_id, company_code,role_type,role_code,  role_name, role_status, create_date, create_by) 
   	values(SEQ_ROLE.NEXTVAL,#companyCode#,1,1,#roleName#,0,sysdate,#userId#)
   </insert>
   
   <select id="getRoleCount" parameterClass="java.lang.String" resultClass="java.lang.Integer">
   	select count(*) from tm_menu_role where role_id=#roleID#
   </select>
   
   <select id="getPositionCount" parameterClass="java.lang.String" resultClass="java.lang.Integer">
   	select count(*) from tm_position_role where role_id=#roleID#
   </select>
   
   <delete id="deleteRoleInfo" parameterClass="java.lang.String">
   	delete tm_role where role_id = #roleID#
   </delete>
   
   <select id="getOneRoleInfo" parameterClass="java.lang.String" resultMap="roleResult">
   	select role_id, company_code, role_type, role_code, role_name, role_status 
   	from tm_role 
   	where role_id=#roleID#
   </select>
   
   <update id="modifyOneRoleInfo" parameterClass="roleVO">
   	update tm_role   set  role_name =#roleName#,create_date = sysdate,create_by =#userId# where role_id =#roleID#
   </update>
   
   <select id="getRolePrivile" resultMap="rolePrivileResult">
   	select menu_id, menu_name,  parent_menu_id,level 
   	from tm_menu t start with parent_menu_id=0 connect by prior menu_id=parent_menu_id
   </select>
   
   <select id="getRolePrivileT" resultMap="rolePrivileResult">
   	select menu_id, menu_name,  parent_menu_id,level
   	from tm_menu t start with parent_menu_id=0 connect by prior menu_id=parent_menu_id
   </select>
   
   <select id="getMenuRole" parameterClass="java.lang.String" resultClass="java.lang.String">
   	select menu_id from tm_menu_role where role_id=#roleID#
   </select>
   
   <delete id="deleteMenuRole" parameterClass="java.lang.String">
   	delete tm_menu_role where role_id = #roleID#
   </delete>
   
   <delete id="deleteMenuRoleT" parameterClass="java.lang.String">
   	delete tm_menu_role t where t.menu_id in (select menu_id from tm_menu s where t.menu_id=s.menu_id ) and t.role_id=#roleID#
   </delete>
   
   <insert id="insertMenuRole" parameterClass="RoleMenuVO">
   	insert into tm_menu_role(menu_role_id, role_id, menu_id, create_date, create_by, company_code)  
   	values(SEQ_MENU_ROLE.NEXTVAL, #roleID#, #menuID#,sysdate,#createBy#,#companyCode#)
   </insert>
   
   <select id="getPositionUser" parameterClass="PositionVO" resultClass="java.lang.String">
   	select user_id 
   	from tm_position_user  where company_code=#comCode# 
   	and position_id in(select position_id from tm_position_role t where t.company_code=#comCode# 
   	and  t.role_id=#roleID#)
   </select>
   
   <select id="getFuncCount" parameterClass="PositionVO" resultClass="java.lang.Integer">
   	select count(*) from tt_function_pwd 
   	where user_id=#userId# and company_code=#comCode# and func_name=#funcName#
   </select>
   
   <insert id="insertFuncPwd" parameterClass="PositionVO">
   	insert into tt_function_pwd(func_name, user_id, func_pwd, company_code, func_cnname) 
   	values(#funcName#, #userId#, #funcPwd#, #comCode#,#funcCnName#)
   </insert>
   
   <delete id="deleteFuncPwd" parameterClass="PositionVO">
   	delete tt_function_pwd 
   	where user_id=#userId# and company_code=#comCode# and func_name=#funcName#
   </delete>
</sqlMap>