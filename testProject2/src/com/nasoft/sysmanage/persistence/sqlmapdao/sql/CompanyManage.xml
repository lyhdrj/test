<?xml version="1.0" encoding="GBK"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap namespace="CompanyManage">

    <typeAlias alias="company" type="com.nasoft.sysmanage.model.CompanyBean"/>
    <typeAlias alias="userLogin" type="com.nasoft.sysmanage.model.UserLoginBean"/>
    
    <resultMap id="companyResult" class="company">
        <result property="number" column="rownum"/>
        <result property="companyCode" column="company_code"/>
        <result property="companyName" column="company_name"/>
        <result property="parentComCode" column="parent_com_code"/>
        <result property="shortName" column="short_name"/>
        <result property="phone" column="phone_number"/>
        <result property="address" column="address"/>
        <result property="zipcode" column="zipcode"/>
        <result property="fax" column="fax"/>
        <result property="status" column="status"/>
    </resultMap>
     
    <resultMap id="companyInfoResult" class="company">
        <result property="number" column="rownum"/>
        <result property="companyCode" column="company_code"/>
        <result property="companyName" column="company_name"/>
        <result property="parentComCode" column="parent_com_code"/>
        <result property="parentComName" column="parent_com_name"/>
        <result property="shortName" column="short_name"/>
        <result property="phone" column="phone_number"/>
        <result property="address" column="address"/>
        <result property="zipcode" column="zipcode"/>
        <result property="fax" column="fax"/>
        <result property="status" column="status"/>
    </resultMap>

	<!--管理员登录，查询所有公司和部门--> 
    <select id="getCompanyCode" resultMap="companyResult" parameterClass="userLogin">
        select rownum,company_code, company_name, parent_com_code, short_name, phone_number, address, zipcode, fax, status 
        from tm_company
        <dynamic prepend="where">
			<isNotNull property="managementCode">
			     company_code=#managementCode#
			</isNotNull>
		</dynamic> 
    </select>
    
    <!--部门管理员--> 
    <select id="getOrgCount" resultClass="java.lang.Integer" parameterClass="java.lang.String">
        select count(*) from tm_org where org_code=#managementCode#
    </select>
    
    <select id="getUserDepartment" resultClass="java.lang.String" parameterClass="java.lang.String">
    	(select status from tm_company where company_code=#userManagementCode#)
    	union 
    	(select status from tm_org where org_code=#userManagementCode#)
    </select>
    
    <select id="getCompanyName" resultClass="java.lang.String" parameterClass="java.lang.String">
    	select company_name from tm_company where company_code=#companyCode#
    </select>
   
    <select id="getCompanyInfo" parameterClass="java.lang.String" resultMap="companyInfoResult">
    	select rownum,t.company_code, t.company_name, t.parent_com_code,(select company_name from tm_company where company_code=#parentComCode#) as parent_com_name
    	, t.short_name, t.phone_number, t.address, t.zipcode, t.fax, t.status 
    	from tm_company t where t.parent_com_code=#parentComCode#
    </select>
    
    <select id="getCompanyNameCount" resultClass="java.lang.Integer" parameterClass="company">
    	select count(*) from tm_company where company_name=#companyName#
		<dynamic prepend="and">
			<isNotNull property="companyCode">
			     company_code!=#companyCode#
			</isNotNull>
		</dynamic>
    </select>
    
    <select id="getCompanyCodeCount" resultClass="java.lang.Integer" parameterClass="company">
    	select count(*) from tm_company  where company_code=#companyCode#
    </select>
    
     <select id="getSubComCount" resultClass="java.lang.Integer" parameterClass="java.lang.String">
    	select count(*) from tm_company  where parent_com_code=#parentComCode#
    </select>
    
    <insert id="addCompanyInfo" parameterClass="company">
    	insert into tm_company(company_code, company_name, parent_com_code, phone_number, address, zipcode, fax,status, create_date, create_by) 
    	values(#companyCode#,#companyName#,0,#phone#,#address#,#zipcode#,#fax#,1,sysdate,#userId#)
    </insert>
    
    <select id="getOneInfo" parameterClass="java.lang.String" resultMap="companyInfoResult">
    	select rownum,t.company_code, t.company_name, t.parent_com_code,case when parent_com_code='0' then '无' else 
    	(select h.company_name from tm_company h where h.company_code=t.parent_com_code) end parent_com_name,t.short_name, t.phone_number, t.address, t.zipcode, t.fax,t.status 
    	from tm_company t  
    	where t.company_code=#companyCode#
    </select>
    
    <update id="updateOneCompanyFunc" parameterClass="company">
		update tm_company set company_name = #companyName#,phone_number = #phone#,address = #address#,zipcode = #zipcode#,fax = #fax#
		,create_date = sysdate, create_by = #userId# 
		where company_code = #companyCode#    
    </update>
    
    <delete id="deleteOneCompanyFunc" parameterClass="company">
		delete tm_company 
		where company_code = #companyCode#    
    </delete>
    
    <delete id="deleteOrg" parameterClass="company">
		delete tm_org 
		where company_code = #companyCode#    
    </delete>
    
    <delete id="deleteUser" parameterClass="company">
		delete tm_user
		where company_code = #companyCode#    
    </delete>
    
    <delete id="deletePositionUser" parameterClass="company">
		delete tm_position_user
		where company_code = #companyCode#    
    </delete>
    
    <delete id="deletePositionRole" parameterClass="company">
		delete tm_position_role
		where company_code = #companyCode#    
    </delete>
    
    <delete id="deletePosition" parameterClass="company">
		delete tm_position
		where company_code = #companyCode#    
    </delete>
</sqlMap>