<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap namespace="OrgManage">

    <typeAlias alias="orgBean" type="com.nasoft.sysmanage.model.OrgBean"/>
    <typeAlias alias="userLogin" type="com.nasoft.sysmanage.model.UserLoginBean"/>
    <resultMap id="orgInfoResult" class="orgBean">
        <result property="number" column="rownum"/>
        <result property="orgCode" column="code"/>
        <result property="orgName" column="name"/>
        <result property="parentOrgCode" column="parentcode"/>
    </resultMap>
    
    <resultMap id="orgResult" class="orgBean">
        <result property="orgCode" column="code"/>
        <result property="orgName" column="name"/>
        <result property="parentOrgCode" column="parentcode"/>
    </resultMap>
    
    <resultMap id="orgNameResult" class="orgBean">
        <result property="orgName" column="org_name"/>
        <result property="comCode" column="company_code"/>
    </resultMap>
    
     <resultMap id="orgResultOne" class="orgBean">
       <result property="orgID" column="org_id"/>
       <result property="comCode" column="company_code"/>
       <result property="orgCode" column="org_code"/>
       <result property="orgName" column="org_name"/>
       <result property="parentOrgCode" column="parent_org_code"/>
       <result property="remark" column="remark"/>
       <result property="parentOrgName" column="parent_org_name"/>
   </resultMap>

	<!--管理员登录，查询所有公司和部门--> 
    <select id="getAllOrgInfo" resultMap="orgInfoResult">
        select rownum,code,name,parentcode from
		 (select company_code as code, company_name as name , parent_com_code as parentCode from tm_company
		 union all select  org_code, org_name, parent_org_code from tm_org)
    </select>
    
    <select id="getOrgInfo" resultMap="orgResult" parameterClass="userLogin">
    	select code, name, parentcode from
		  ((select company_code as code, company_name as name, parent_com_code as parentCode, status from tm_company t where t.company_code=#company_code#)
		   union (select org_code, org_name, parent_org_code, status from tm_org t where t.company_code=#company_code#)) where status!=1 or (status=1 and code=#managementCode#)
    </select>
    
    <!-- 获得部门信息 -->
    <select id="getOrgName" resultMap="orgNameResult" parameterClass="java.lang.String">
    	select org_name,company_code from tm_org where org_code=#parentOrgCode#
		 union  
		select company_name,company_code from tm_company where company_code=#parentOrgCode#
    </select>
    
    <!-- 得到一个单位下的所有下级单位名称等信息 -->
    <select id="getOrgSubInfo" resultMap="orgInfoResult" parameterClass="java.lang.String">
    	select rownum ,org_code as code , org_name as name , parent_org_code as parentcode from tm_org 
	    	where  parent_org_code=#parentOrgCode#
    </select>
    
    <select id="getOrgNameCount" resultClass="java.lang.Integer" parameterClass="orgBean">
    	select count(*) from tm_org  where org_name=#orgName# and company_code=#comCode# and parent_org_code=#parentOrgCode#
    </select>
    
    <select id="getOrgCodeCount" resultClass="java.lang.Integer" parameterClass="orgBean">
		select count(*) from tm_org  where org_code=#comCode#||#orgCode#
		and company_code=#comCode#
    </select>
    
    <select id="getOrgCodeCountT" resultClass="java.lang.Integer" parameterClass="orgBean">
    	select count(*) from tm_org  
    	where org_name=#orgName# and org_code!=#orgCode# and parent_org_code=#parentOrgCode#
    </select>
    
    <insert id="addOrgInfo" parameterClass="orgBean">
    	insert into tm_org(org_id, company_code, org_code, org_name, parent_org_code, remark, status, create_date, create_by) 
    	values(SEQ_ORG.NEXTVAL,#comCode#,#comCodeAndOrgCode#,#orgName#,#parentOrgCode#,#remark#,2,sysdate,#userId#)
    </insert>
    
    <select id="getOneInfo" resultMap="orgResultOne" parameterClass="java.lang.String">
       select t.org_id, t.company_code, t.org_code, t.org_name, t.parent_org_code, t.remark,h.org_name parent_org_name 
       from tm_org t ,tm_org h where t.parent_org_code=h.org_code and t.org_code=#orgCode#
	   union 
	   select t.org_id, t.company_code, t.org_code, t.org_name, t.parent_org_code, t.remark,h.company_name 
	   from tm_org t ,tm_company h where t.parent_org_code=h.company_code and t.org_code=#orgCode#
    </select>
    
    <update id="updateOneInfo" parameterClass="orgBean">
    update tm_org  set  org_name =#orgName#, remark =#remark#, create_date = sysdate,create_by =#userId# 
    where org_code =#orgCode#
    </update>
    
    <delete id="deletePositionRole" parameterClass="java.lang.String">
    delete from tm_position_role where position_id in (select position_id from tm_position tp where org_code=#orgCode#)
    </delete>
    
    <delete id="deletePosition" parameterClass="java.lang.String">
    delete tm_position where org_code=#orgCode#
    </delete>
    
    <delete id="deleteOneInfo" parameterClass="java.lang.String">
    delete tm_org where org_code=#orgCode#
    </delete>
    
    <select id="getSubOrgCount" parameterClass="java.lang.String" resultClass="java.lang.Integer">
   	 select count(*) from tm_org where parent_org_code = #orgCode#
   </select>

   <delete id="deleteOrgInfo" parameterClass="java.lang.String">
    delete tm_org where parent_org_code=#orgCode#
    </delete>
    
    <delete id="deletePositionUser" parameterClass="java.lang.String">
    delete from tm_position_user where position_id in (select position_id from tm_position tp where org_code=#orgCode#)
    </delete>
    
    <select id="getUserIds" resultClass="java.lang.String" parameterClass="java.lang.String">
   	 select user_id from tm_position_user where position_id in (select position_id from tm_position tp where org_code=#orgCode#)
   </select>
    <delete id="deleteTmUser" parameterClass="java.util.List">
    delete from tm_user 
    <iterate prepend="WHERE"
		   conjunction="OR">
		   user_id=#userIdList[]#
		  </iterate>
    </delete>
</sqlMap>